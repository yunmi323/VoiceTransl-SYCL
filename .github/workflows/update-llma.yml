name: Build and Package Project

# 允许手动触发工作流
on:
  workflow_dispatch:

jobs:
  build-and-package:
    runs-on: windows-latest  # 使用 Windows 环境，因为要下载 Windows 二进制文件

    steps:
      # 1. 克隆 https://github.com/shinnpuru/VoiceTransl.git 的 main 分支
      - name: Clone VoiceTransl repository
        uses: actions/checkout@v3
        with:
          repository: shinnpuru/VoiceTransl
          ref: main

      # 调试步骤：查看当前目录内容
      - name: List current directory contents
        shell: pwsh
        run: Get-ChildItem

      # 3. 删除克隆项目中的 llma 文件夹
      - name: Delete llama folder
        shell: pwsh
        run: |
          if (Test-Path -Path "llama") {
            try {
              Remove-Item -Path "llama" -Recurse -Force -ErrorAction Stop
              Write-Host "Successfully deleted the llama folder."
            } catch {
              Write-Error "Failed to delete the llama folder: $_"
              throw
            }
          } else {
            Write-Host "The llama folder does not exist."
          }

      # 4. 下载最新的包含 llama-【release tag】-bin-win-sycl-x64.zip 的 release 并解压
      - name: Download and extract llama zip
        shell: pwsh
        run: |
          $releases = Invoke-RestMethod -Uri "https://api.github.com/repos/ggerganov/llama.cpp/releases"
          $found = $false
          foreach ($release in $releases) {
            $tag = $release.tag_name
            $assets = $release.assets
            foreach ($asset in $assets) {
              if ($asset.name -like "llama-$tag-bin-win-sycl-x64.zip") {
                $zipUrl = $asset.browser_download_url
                Invoke-WebRequest -Uri $zipUrl -OutFile "llama-$tag-bin-win-sycl-x64.zip"
                Expand-Archive -Path "llama-$tag-bin-win-sycl-x64.zip" -DestinationPath "./temp_llma"
                Remove-Item -Path "llama-$tag-bin-win-sycl-x64.zip"
                $found = $true
                break
              }
            }
            if ($found) {
              break
            }
          }
          if (-not $found) {
            throw "Could not find a release with llama-【release tag】-bin-win-sycl-x64.zip"
          }

      # 5. 将解压后的文件夹重命名为 llma 并移动到克隆项目的根目录
      - name: Rename and move folder
        shell: pwsh
        run: |
          if (Test-Path -Path "./temp_llma") {
            Move-Item -Path "./temp_llma" -Destination "./llma" -Force
            Write-Host "Successfully moved and renamed the folder to llma."
          } else {
            Write-Error "The temp_llma folder does not exist."
            throw
          }

      # 6. 安装 Python 依赖并使用 PyInstaller 构建项目
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.10  # 可以根据项目需求调整 Python 版本

      - name: Install dependencies and build project
        working-directory: ./VoiceTransl
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
          pyinstaller app.spec
        shell: powershell

      # 7. 将构建好的项目打包上传
      - name: Package and upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: built-project
          path: ./VoiceTransl/dist
